# Copyright 2018 Google LLC

steps:
# This step runs the unit tests on the app
- name: 'python:3.7-slim'
  id: Test
  entrypoint: /bin/sh
  args:
  - -c
  - 'pip install flask pytest && python -m pytest test_app.py'

# This step builds the container image.
- name: 'gcr.io/cloud-builders/docker'
  id: Build
  args:
  - 'build'
  - '-t'
  - 'gcr.io/$PROJECT_ID/hello-cloudbuild:$SHORT_SHA'
  - '.'

# This step pushes the image to Artifact Registry
- name: 'gcr.io/cloud-builders/docker'
  id: Push
  args:
  - 'push'
  - 'gcr.io/$PROJECT_ID/hello-cloudbuild:$SHORT_SHA'

# This step clones the hello-cloudbuild-env repository
- name: 'gcr.io/cloud-builders/gcloud'
  id: Clone env repository
  entrypoint: /bin/sh
  args:
  - -c
  - |
    gcloud secrets versions access 1 --secret=ssh_key_secret > /root/.ssh/id_rsa
    chmod 600 /root/.ssh/id_rsa
    ssh-keyscan -t rsa github.com > /root/.ssh/known_hosts
    git clone git@github.com:Monicat7777/hello-cloudbuild-env.git
  volumes:
  - name: 'ssh'
    path: '/root/.ssh'

# This step updates the manifest in the env repository
- name: 'gcr.io/cloud-builders/gcloud'
  id: Update manifest
  entrypoint: /bin/sh
  args:
  - -c
  - |
    cd hello-cloudbuild-env
    sed -i "s|image:.*|image: gcr.io/$PROJECT_ID/hello-cloudbuild:$SHORT_SHA|" kubernetes.yaml
  volumes:
  - name: 'ssh'
    path: '/root/.ssh'

# This step pushes the updated manifest back to the env repository
- name: 'gcr.io/cloud-builders/gcloud'
  id: Push manifest
  entrypoint: /bin/sh
  args:
  - -c
  - |
    cd hello-cloudbuild-env
    git config user.email "student-01-f3cc91d86c66@qwiklabs.net"
    git config user.name "Student"
    git add kubernetes.yaml
    git commit -m "Deploying image gcr.io/$PROJECT_ID/hello-cloudbuild:$SHORT_SHA built from commit $COMMIT_SHA"
    git push origin production
  volumes:
  - name: 'ssh'
    path: '/root/.ssh'

options:
  logging: CLOUD_LOGGING_ONLY
